#!/bin/bash
# Backup script for network-docker VM
# Managed by Ansible - do not edit directly

set -euo pipefail

# Configuration
BACKUP_DIR="{{ vm_network_docker_backup_mount }}/servers/{{ ansible_hostname }}"
HOSTNAME="{{ ansible_hostname }}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="${BACKUP_DIR}/${HOSTNAME}-${TIMESTAMP}.tar.gz"
RETENTION_DAYS={{ vm_network_docker_backup_retention_days }}
LOG_FILE="/var/log/network-docker-backup.log"

# Logging function
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "${LOG_FILE}"
}

# Error handling
error_exit() {
    log "ERROR: $1"
    exit 1
}

log "=========================================="
log "Starting backup for ${HOSTNAME}"
log "=========================================="

# Check if backup directory is accessible
if [ ! -d "${BACKUP_DIR}" ]; then
    error_exit "Backup directory ${BACKUP_DIR} does not exist or is not accessible"
fi

# Check if Docker is running
if ! systemctl is-active --quiet docker; then
    error_exit "Docker service is not running"
fi

# Create temporary directory for staging
TMP_DIR=$(mktemp -d)
trap 'rm -rf ${TMP_DIR}' EXIT

log "Staging backup in ${TMP_DIR}"

# Backup Docker volumes (the actual data)
log "Backing up Docker volumes..."
if [ -d /var/lib/docker/volumes ]; then
    mkdir -p "${TMP_DIR}/volumes"
    tar czf "${TMP_DIR}/volumes/docker-volumes.tar.gz" -C /var/lib/docker volumes/ 2>&1 | tee -a "${LOG_FILE}" || error_exit "Failed to backup Docker volumes"
    log "Docker volumes backed up successfully"
else
    error_exit "Docker volumes directory not found"
fi

# Backup container states and compose files
log "Backing up container configurations..."
mkdir -p "${TMP_DIR}/configs"

# Backup UniFi compose
if [ -f /opt/unifi/docker-compose.yml ]; then
    cp /opt/unifi/docker-compose.yml "${TMP_DIR}/configs/" || log "Warning: Failed to copy UniFi compose"
fi

# Backup Netbox compose and env
if [ -d /opt/netbox ]; then
    mkdir -p "${TMP_DIR}/configs/netbox"
    [ -f /opt/netbox/docker-compose.yml ] && cp /opt/netbox/docker-compose.yml "${TMP_DIR}/configs/netbox/" || true
    [ -d /opt/netbox/env ] && cp -r /opt/netbox/env "${TMP_DIR}/configs/netbox/" || true
    [ -d /opt/netbox/configuration ] && cp -r /opt/netbox/configuration "${TMP_DIR}/configs/netbox/" || true
fi

log "Container configurations backed up"

# Get list of running containers
log "Capturing container state..."
docker ps -a --format "table {{ '{{' }}.Names{{ '}}' }}\t{{ '{{' }}.Image{{ '}}' }}\t{{ '{{' }}.Status{{ '}}' }}" > "${TMP_DIR}/container-list.txt" 2>&1 || log "Warning: Failed to capture container list"

# Get Docker networks
docker network ls > "${TMP_DIR}/docker-networks.txt" 2>&1 || log "Warning: Failed to capture network list"

# Create the final backup archive
log "Creating backup archive ${BACKUP_FILE}..."
tar czf "${BACKUP_FILE}" -C "${TMP_DIR}" . 2>&1 | tee -a "${LOG_FILE}" || error_exit "Failed to create backup archive"

# Verify backup was created successfully
if [ -f "${BACKUP_FILE}" ]; then
    BACKUP_SIZE=$(du -h "${BACKUP_FILE}" | cut -f1)
    log "Backup created successfully: ${BACKUP_FILE} (${BACKUP_SIZE})"
else
    error_exit "Backup file was not created"
fi

# Housekeeping - remove old backups (only after successful backup)
log "Performing housekeeping (keeping last ${RETENTION_DAYS} days)..."
find "${BACKUP_DIR}" -name "${HOSTNAME}-*.tar.gz" -type f -mtime +${RETENTION_DAYS} -print -delete 2>&1 | tee -a "${LOG_FILE}" || log "Warning: Housekeeping encountered errors"

# List remaining backups
log "Current backups:"
ls -lh "${BACKUP_DIR}"/${HOSTNAME}-*.tar.gz 2>&1 | tee -a "${LOG_FILE}" || log "No backups found"

log "=========================================="
log "Backup completed successfully"
log "=========================================="

exit 0
