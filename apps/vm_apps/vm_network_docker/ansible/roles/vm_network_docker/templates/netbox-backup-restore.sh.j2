#!/bin/bash
# Netbox Backup and Restore Script
# Handles backup of Netbox configuration, environment files, and docker volumes
# Manages restore operations for fresh installations

set -euo pipefail

BACKUP_MOUNT="{{ vm_network_docker_backup_mount }}"
BACKUP_DIR="$BACKUP_MOUNT/servers/$(hostname)"
NETBOX_DIR="/opt/netbox"
NETBOX_COMPOSE_DIR="/opt/netbox"
DOCKER_VOLUMES_DIR="/var/lib/docker/volumes"
NETBOX_DOCKER_NETWORKS_FILE="/tmp/netbox-networks.txt"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_RETENTION_DAYS="{{ vm_network_docker_backup_retention_days }}"

# Ensure backup directory exists
mkdir -p "$BACKUP_DIR"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Function to backup Netbox
backup_netbox() {
    log_info "Starting Netbox backup..."
    
    BACKUP_FILE="$BACKUP_DIR/netbox-backup-${TIMESTAMP}.tar.gz"
    BACKUP_TMP=$(mktemp -d)
    trap "rm -rf $BACKUP_TMP" EXIT
    
    # Create backup structure
    mkdir -p "$BACKUP_TMP/configs/netbox"
    mkdir -p "$BACKUP_TMP/volumes"
    
    # Backup Netbox docker-compose
    if [ -f "$NETBOX_COMPOSE_DIR/docker-compose.yml" ]; then
        cp "$NETBOX_COMPOSE_DIR/docker-compose.yml" "$BACKUP_TMP/configs/netbox/"
        log_info "Backed up Netbox docker-compose"
    fi
    
    if [ -f "$NETBOX_COMPOSE_DIR/docker-compose.override.yml" ]; then
        cp "$NETBOX_COMPOSE_DIR/docker-compose.override.yml" "$BACKUP_TMP/configs/netbox/"
        log_info "Backed up Netbox docker-compose override"
    fi
    
    # Backup Netbox environment file
    if [ -f "$NETBOX_DIR/.env" ]; then
        cp "$NETBOX_DIR/.env" "$BACKUP_TMP/configs/netbox/"
        log_info "Backed up Netbox environment file"
    fi
    
    # Backup Netbox configuration directory
    if [ -d "$NETBOX_DIR/configuration" ]; then
        cp -r "$NETBOX_DIR/configuration" "$BACKUP_TMP/configs/netbox/"
        log_info "Backed up Netbox configuration"
    fi
    
    # Backup Netbox docker volumes
    log_info "Backing up Netbox docker volumes..."
    docker network ls --format="{%raw%}{{.Name}}{%endraw%}" | grep -i netbox > "$NETBOX_DOCKER_NETWORKS_FILE" || true
    cat "$NETBOX_DOCKER_NETWORKS_FILE" > "$BACKUP_TMP/netbox-networks.txt"
    
    cd "$DOCKER_VOLUMES_DIR"
    tar -czf "$BACKUP_TMP/volumes/netbox-volumes.tar.gz" \
        netbox_netbox-postgres-data \
        netbox_netbox-redis-data \
        netbox_netbox-redis-cache-data \
        netbox_netbox-media-files \
        netbox_netbox-reports-files \
        netbox_netbox-scripts-files \
        2>/dev/null || log_warn "Some Netbox volumes may not exist yet"
    
    log_info "Backed up Netbox volumes"
    
    # Create final backup archive
    cd "$BACKUP_TMP"
    tar -czf "$BACKUP_FILE" .
    log_info "Created backup archive: $BACKUP_FILE"
    
    # Cleanup old backups
    log_info "Cleaning up backups older than $BACKUP_RETENTION_DAYS days..."
    find "$BACKUP_DIR" -name "netbox-backup-*.tar.gz" -mtime +$BACKUP_RETENTION_DAYS -delete
    
    log_info "Backup completed successfully"
}

# Function to restore Netbox
restore_netbox() {
    log_info "Starting Netbox restore..."
    
    # Find latest Netbox backup
    LATEST_BACKUP=$(find "$BACKUP_DIR" -name "netbox-backup-*.tar.gz" -type f | sort -r | head -1)
    
    if [ -z "$LATEST_BACKUP" ]; then
        log_error "No Netbox backup found in $BACKUP_DIR"
        return 1
    fi
    
    log_info "Restoring from: $LATEST_BACKUP"
    
    RESTORE_TMP=$(mktemp -d)
    trap "rm -rf $RESTORE_TMP" EXIT
    
    # Extract backup
    tar -xzf "$LATEST_BACKUP" -C "$RESTORE_TMP"
    log_info "Extracted backup"
    
    # Restore docker volumes
    if [ -f "$RESTORE_TMP/volumes/netbox-volumes.tar.gz" ]; then
        log_info "Restoring Netbox volumes..."
        cd "$DOCKER_VOLUMES_DIR"
        tar -xzf "$RESTORE_TMP/volumes/netbox-volumes.tar.gz"
        log_info "Volumes restored"
    fi
    
    # Restore Netbox configurations
    if [ -d "$RESTORE_TMP/configs/netbox" ]; then
        log_info "Restoring Netbox configurations..."
        
        # Restore environment file
        if [ -f "$RESTORE_TMP/configs/netbox/.env" ]; then
            cp "$RESTORE_TMP/configs/netbox/.env" "$NETBOX_DIR/" || true
        fi
        
        # Restore configuration directory
        if [ -d "$RESTORE_TMP/configs/netbox/configuration" ]; then
            cp -r "$RESTORE_TMP/configs/netbox/configuration" "$NETBOX_DIR/" || true
        fi
        
        # Restore docker-compose files
        if [ -f "$RESTORE_TMP/configs/netbox/docker-compose.yml" ]; then
            cp "$RESTORE_TMP/configs/netbox/docker-compose.yml" "$NETBOX_COMPOSE_DIR/" || true
        fi
        
        if [ -f "$RESTORE_TMP/configs/netbox/docker-compose.override.yml" ]; then
            cp "$RESTORE_TMP/configs/netbox/docker-compose.override.yml" "$NETBOX_COMPOSE_DIR/" || true
        fi
        
        log_info "Configurations restored"
    fi
    
    # Restart Netbox containers
    log_info "Restarting Netbox containers..."
    cd "$NETBOX_COMPOSE_DIR"
    docker compose -f docker-compose.yml -f docker-compose.override.yml restart || true
    
    log_info "Restore completed successfully"
}

# Main logic
case "${1:-}" in
    backup)
        backup_netbox
        ;;
    restore)
        restore_netbox
        ;;
    *)
        echo "Usage: $0 {backup|restore}"
        echo ""
        echo "  backup  - Create a backup of Netbox configuration and volumes"
        echo "  restore - Restore from the latest Netbox backup"
        exit 1
        ;;
esac
